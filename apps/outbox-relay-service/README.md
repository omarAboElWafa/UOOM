# Outbox Relay Service

The Outbox Relay Service is a critical component of the UOOM platform that ensures reliable event delivery from the transactional outbox pattern to Kafka message broker. It polls the outbox events table and publishes events to appropriate Kafka topics with retry logic and dead letter queue handling.

## üéØ Purpose

- **Reliable Event Delivery**: Ensures all events generated by the orchestration service are delivered to Kafka
- **Retry Logic**: Implements exponential backoff for failed message deliveries
- **Dead Letter Queue**: Handles permanently failed messages to prevent data loss
- **High Performance**: Processes events in batches with configurable concurrency
- **Monitoring**: Provides comprehensive health checks and metrics

## üèóÔ∏è Architecture

### Components

1. **OutboxProcessorService**: Core service that polls and processes outbox events
2. **KafkaProducerService**: Handles Kafka message publishing with retry logic
3. **HealthController**: Provides health checks for Kubernetes/Docker
4. **MetricsController**: Exposes processing metrics for monitoring

### Processing Flow

```
1. Poll outbox_events table for unprocessed events
2. Transform events into Kafka messages
3. Publish to appropriate Kafka topics
4. Mark events as processed or failed
5. Handle retries with exponential backoff
6. Send permanently failed events to DLQ
```

## üöÄ Getting Started

### Prerequisites

- Node.js 18+
- PostgreSQL (for outbox events)
- Kafka (for event publishing)

### Installation

```bash
# Install dependencies
npm install

# Copy environment configuration
cp .env.example .env

# Configure your environment variables
vim .env
```

### Running the Service

```bash
# Development mode
npm run start:dev

# Production mode
npm run build
npm run start:prod

# Docker
docker build -t outbox-relay-service .
docker run -p 3003:3003 outbox-relay-service
```

## ‚öôÔ∏è Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | `3003` | HTTP server port |
| `OUTBOX_BATCH_SIZE` | `100` | Number of events to process per batch |
| `OUTBOX_MAX_RETRIES` | `3` | Maximum retry attempts for failed events |
| `OUTBOX_PROCESSING_INTERVAL_MS` | `5000` | Polling interval in milliseconds |
| `OUTBOX_CONCURRENCY_LIMIT` | `10` | Max concurrent event processing |
| `KAFKA_BROKERS` | `localhost:9092` | Kafka broker addresses |
| `KAFKA_MAX_RETRIES` | `3` | Kafka publish retry attempts |

### Topic Mapping

Events are automatically routed to Kafka topics based on their type:

- **Order Events** ‚Üí `orders` topic
- **Capacity Events** ‚Üí `capacity` topic  
- **Optimization Events** ‚Üí `optimization` topic
- **Unknown Events** ‚Üí `default-events` topic

## üìä Monitoring

### Health Checks

- **Liveness**: `GET /api/v1/health/live` - Basic application health
- **Readiness**: `GET /api/v1/health/ready` - Ready to serve traffic
- **Health**: `GET /api/v1/health` - Comprehensive health check

### Metrics

- **Basic Metrics**: `GET /api/v1/metrics`
- **Prometheus Format**: `GET /api/v1/metrics/prometheus`
- **Health Summary**: `GET /api/v1/metrics/health-summary`

### Key Metrics

- `outbox_events_processed_total` - Total events processed
- `outbox_events_succeeded_total` - Successfully published events
- `outbox_events_failed_total` - Failed events
- `outbox_processing_time_avg` - Average processing time
- `outbox_processor_healthy` - Processor health status

## üîß API Endpoints

### Health Endpoints

```bash
# Check if service is alive
curl http://localhost:3003/api/v1/health/live

# Check if service is ready
curl http://localhost:3003/api/v1/health/ready

# Comprehensive health check
curl http://localhost:3003/api/v1/health
```

### Metrics Endpoints

```bash
# Get processing metrics
curl http://localhost:3003/api/v1/metrics

# Get Prometheus metrics
curl http://localhost:3003/api/v1/metrics/prometheus

# Get health summary with alerts
curl http://localhost:3003/api/v1/metrics/health-summary
```

## üö® Error Handling

### Retry Strategy

1. **Immediate Retry**: First failure triggers immediate retry
2. **Exponential Backoff**: Subsequent retries use exponential delays
3. **Max Retries**: After 3 failed attempts, event goes to DLQ
4. **Dead Letter Queue**: Failed events are preserved for manual inspection

### Failure Scenarios

- **Kafka Unavailable**: Events are retried with backoff
- **Database Connection**: Service health check fails, alerts triggered
- **Processing Errors**: Individual event failures don't stop batch processing
- **Network Issues**: Automatic retry with exponential backoff

## üîç Debugging

### Common Issues

1. **High Processing Time**
   - Check Kafka broker performance
   - Verify database connection pool
   - Monitor network latency

2. **Failed Events**
   - Check dead letter queue topic
   - Verify Kafka topic permissions
   - Review error logs

3. **Stale Processing**
   - Check database connectivity
   - Verify no locks on outbox_events table
   - Monitor service memory usage

### Logs

The service provides structured logging with different levels:

- `ERROR`: Failed operations, exceptions
- `WARN`: Retries, degraded performance
- `INFO`: Normal operations, metrics
- `DEBUG`: Detailed processing information

## üèÉ‚Äç‚ôÇÔ∏è Performance

### Throughput

- **Batch Processing**: Configurable batch size (default: 100 events)
- **Concurrent Processing**: Parallel event handling (default: 10 concurrent)
- **Polling Frequency**: Every 5 seconds (configurable)

### Optimization Tips

1. **Increase Batch Size**: For higher throughput, increase `OUTBOX_BATCH_SIZE`
2. **Tune Concurrency**: Adjust `OUTBOX_CONCURRENCY_LIMIT` based on resources
3. **Database Indexing**: Ensure proper indexes on `outbox_events` table
4. **Kafka Partitioning**: Use appropriate partition keys for load distribution

## üß™ Testing

```bash
# Unit tests
npm run test

# Integration tests
npm run test:e2e

# Coverage report
npm run test:cov
```

## üì¶ Deployment

### Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3003
CMD ["npm", "run", "start:prod"]
```

### Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: outbox-relay-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: outbox-relay-service
  template:
    metadata:
      labels:
        app: outbox-relay-service
    spec:
      containers:
      - name: outbox-relay
        image: outbox-relay-service:latest
        ports:
        - containerPort: 3003
        env:
        - name: DB_HOST
          value: "postgres-service"
        - name: KAFKA_BROKERS
          value: "kafka-service:9092"
        livenessProbe:
          httpGet:
            path: /api/v1/health/live
            port: 3003
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/v1/health/ready
            port: 3003
          initialDelaySeconds: 5
          periodSeconds: 5
```

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## üìÑ License

This project is licensed under the MIT License. 